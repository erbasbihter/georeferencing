---
title: "Georeference for Small Towns"
author: "Bihter Erbas"
date: "02/03/2023"
output: pdf_document
---

In this document, I'm outlining the steps for the matching process for small localities in Congo.

### 1. Preamble: Load packages and SIGE data

First, I import the SIGE data with harmonized school names

```{r setup, include=FALSE}
rm(list=ls())
library(sf)
library(rgeos)
library(rgdal)
library(dplyr)
library(tidyverse)
library(stringr)
library(readxl)
library(tmap)
library(rstudioapi)
library(here) # Package to access parent directory while reading files (to rerun the code smoothly anywhere)

# Set the path current open file
current_path = rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path ))


sigeschools.all <- read_excel(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "raw")),'sigeschools.xlsx', sep="/"))

``` 

### 2. Load CENI and filter small localities

I'm loading and filtering the CENI data with harmonized school names. The smaller towns are the ones not in Kinshasa, not part of VILLE, for which ceni_group_quart is blank. This represents 174

```{r}
ceni_raw <- read_excel(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "raw")),'cenischools_clean_v3.xlsx', sep="/")) %>%
  dplyr::relocate(c(province, circonscription, clcr, ceni_sect_chef_comm, ceni_group_quart, ceni_address_vill_avenue, ceni_nom_sv)) %>%
  dplyr::filter(province != "KINSHASA") %>%
  dplyr::filter(!str_detect(circonscription,"\\sVILLE")) %>%
  dplyr::filter(is.na(ceni_group_quart)) %>%
  #dplyr::filter(str_detect(ceni_group_quart," ")) %>%
  dplyr::mutate(town_province = paste0(ceni_sect_chef_comm,province)) %>%
  dplyr::mutate(town_province = gsub("[[:blank:]]", "", town_province))
```



### 3. Load towns GPS

The following code puts together the three sources of data of the GPS of all the small localities and matches each smaller town in CENI such that there is a latitute and longitude in one of the three datasets.
```{r}
towns_gps1 <- read_sf(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "maps/small_villes")),'COD_CITIES_20180906H.shp', sep="/")) %>%
  dplyr::mutate(ADM1_FR = toupper(ADM1_FR)) %>%
  dplyr::mutate(name = toupper(name)) %>%
  dplyr::mutate(ADM1_FR = ifelse(ADM1_FR == "MAÏ-NDOMBE", "MAI-NDOMBE",ADM1_FR)) %>%
  dplyr::mutate(ADM1_FR = ifelse(ADM1_FR == "KASAÏ", "KASAI",ADM1_FR)) %>%
  dplyr::mutate(ADM1_FR = ifelse(ADM1_FR == "KASAÏ-CENTRAL", "KASAI CENTRAL",ADM1_FR)) %>%
  dplyr::mutate(ADM1_FR = ifelse(ADM1_FR == "KASAÏ-ORIENTAL", "KASAI ORIENTAL",ADM1_FR)) %>%
  dplyr::mutate(ADM1_FR = ifelse(ADM1_FR == "KONGO-CENTRAL", "KONGO CENTRAL",ADM1_FR)) %>%
  dplyr::mutate(town_province = paste0(name,ADM1_FR)) %>%
  dplyr::mutate(town_province = ifelse(town_province == "KINZAU-MVUETEKONGO CENTRAL", "KINZAU-VUETEKONGO CENTRAL",town_province)) %>%
  dplyr::select(c(town_province,geometry,ADM1_FR,name)) %>%
  dplyr::mutate(source = "towns_gps1")



towns_gps2 <- read_sf(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "maps/villes")),'villes.shp', sep="/")) %>%
  dplyr::mutate(province = ifelse(province == "KASAI-CENTRAL", "KASAI CENTRAL",province)) %>%
  dplyr::mutate(province = ifelse(province == "KASAI-ORIENTAL", "KASAI ORIENTAL",province)) %>%
  dplyr::mutate(province = ifelse(province == "KONGO-CENTRAL", "KONGO CENTRAL",province)) %>%
  dplyr::mutate(town_province = paste0(Name,province)) %>%
  dplyr::mutate(ADM1_FR = province) %>%
  dplyr::mutate(name = Name) %>%
  dplyr::select(c(town_province,geometry,ADM1_FR,name)) %>%
  dplyr::mutate(source = "towns_gps2")


towns_gps3 <- read_xlsx(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "maps/other_localities")),'other_localities.xlsx', sep="/"))
towns_gps3 <- st_as_sf(towns_gps3, coords = c("Longitude", "Latitude"), crs = 4326) %>%
  dplyr::mutate(town_province = paste0(ceni_sect_chef_comm,province)) %>%
  dplyr::mutate(name = ceni_sect_chef_comm) %>%
  dplyr::mutate(ADM1_FR = province) %>%
  dplyr::select(c(town_province,geometry,ADM1_FR,name)) %>%
  dplyr::mutate(source = "towns_gps3")

towns_gps <- rbind(towns_gps1, towns_gps2) 
towns_gps <- rbind(towns_gps, towns_gps3) 

towns_gps <- towns_gps %>%
  dplyr::mutate(n = 1) %>%
  dplyr::group_by(town_province) %>%
  dplyr::mutate(tot = sum(n)) %>%
  ungroup() %>%
  dplyr::mutate(todrop = ifelse(source=="towns_gps2" & tot == 2, 1, 0)) %>%
  dplyr::filter(todrop == 0) %>%
  dplyr::select(-c(n, tot)) %>%
  dplyr::mutate(town_province = gsub("[[:blank:]]", "", town_province))

cenischools.all <- left_join(ceni_raw, towns_gps, by = "town_province") 
localities <- length(unique(cenischools.all$town_province))
```

At the end of this matching procedure, we have `r localities` unique small localities in the CENI dataset.

### 4. Generate Matching Variable & Shapefiles CENI and SIGE

I edit the CENI and SIGE datasets and convert them into shapefiles using the GPS coordinates.

```{r}
cenischools.all$ceni_nom_sv <- str_replace_all(cenischools.all$ceni_nom_sv, fixed(" "), "") 

ceni_small_villes_match <- cenischools.all %>%
  dplyr::select(c("ceni_site_vote_ID","ceni_nom_sv","province","ceni_sect_chef_comm", "circonscription", "town_province", "geometry")) %>%
  dplyr::mutate(match_var = paste(ceni_nom_sv)) %>%
  dplyr::mutate(match_var = str_replace_all(match_var, fixed(" "), ""))

sigeschools.all$NomEcole <- str_replace_all(sigeschools.all$NomEcole, fixed(" "), "")

# Extract villes in the SIGE data
sigeschools.all <- sigeschools.all %>%
   dplyr::filter(ProvincePoliAdmin != "KINSHASA") %>%
   dplyr::filter(!str_detect(Territoire,"\\sVILLE")) %>%
   dplyr::mutate_at(.vars=vars(Territoire), list(~ gsub(" ", "", .))) %>%
   dplyr::mutate(town_province = paste0(Territoire,ProvincePoliAdmin)) %>%
   dplyr::mutate(town_province = gsub("[[:blank:]]", "", town_province))


sigeschools.all_sf = st_as_sf(sigeschools.all, coords = c("GPS_longitude", "GPS_latitude"), 
                                    crs = 4326)

cenischools.all_sf = st_as_sf(ceni_small_villes_match, crs=4326)

```


### 5. Looping and Creating Additional Schools within Each Unit

In this section, I extract the \textit{town_province} names from the ceni_small_villes_match dataset and run a loop over each of these small localities to get the final data before I perform matching:

```{r}
small_villes <- unique(ceni_small_villes_match$town_province)


for(s in small_villes) {

  temp_villes_sf <- towns_gps %>%
    dplyr::filter(town_province == s)
  
  temp_ceni_small_villes_match <- ceni_small_villes_match %>%   dplyr::filter(ceni_small_villes_match$town_province == s)
  
  temp_villes_sf_buffer_10km <- st_buffer(temp_villes_sf, 10000)
  
  
  # Identify schools falling within city's buffer
  sigeschools.all_sf_admin <- st_join(sigeschools.all_sf,  temp_villes_sf_buffer_10km, left = FALSE) %>%
    #dplyr::filter(!is.na(town_province.x)) %>%
    #dplyr::distinct(NomEcole, geometry, .keep_all = TRUE) %>%
    dplyr::distinct(NomEcole, .keep_all = TRUE) # HERE I REMOVE DUPLICATE WITHIN SAME VILLE
  
    # Generate Matching Variable SIGE
  temp_sige_match <- sigeschools.all_sf_admin %>%
    dplyr::mutate(match_var = paste(NomEcole)) %>%
    dplyr::mutate(match_var = str_replace_all(match_var, fixed(" "), "")) %>%
    dplyr::mutate(info = NA)
  
  temp_sige_match <- temp_sige_match %>% 
    dplyr::mutate(match_var_trimmed = match_var) %>%
    dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("COMPLEXESCOLAIRE|ECOLEMATERNELLE|COLLEGE|ECOLEPRIMAIRE|LYCEE|INSTITUT|INSTITUTSCIENTIFIQUE|INSTITUTTECHNIQUEAGRICOLE|INSTITUTTECHNIQUEPROFESSIONNEL|INSTITUTTECHNOLOGIQUE|GROUPESCOLAIRE|ACADEMIE", "", .))) %>%  # remove school types
    group_by(match_var_trimmed, town_province.x) %>% add_count(name = "occurence") 
  
# Take all the 1 occurences and add other school types in here
  temp_sige_match.expanded <- temp_sige_match[rep(row.names(temp_sige_match), ifelse(temp_sige_match$occurence==1, 8, 1)), ] %>%
    group_by(match_var_trimmed) %>% dplyr::mutate(ind = row_number()) %>% filter(occurence == 1)

  temp_sige_match.expanded$match_var_trimmed <- paste(temp_sige_match.expanded$ind, temp_sige_match.expanded$match_var_trimmed)
  
 temp_sige_match.expanded<- temp_sige_match.expanded %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(1)\\s+(*.)", "ECOLEPRIMAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(2)\\s+(*.)", " ECOLEMATERNELLE\\2", .))) %>% 
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(3)\\s+(*.)", " COLLEGE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(4)\\s+(*.)", " LYCEE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(5)\\s+(*.)", " INSTITUT\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(6)\\s+(*.)", " GROUPESCOLAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(7)\\s+(*.)", " COMPLEXESCOLAIRE\\2", .))) %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(8)\\s+(*.)", " ACADEMIE\\2", .))) %>%
        dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("\\s\\s", " ", .))) %>% # DOUBLE SPACE
         dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("^\\s|\\s$", "", .))) %>%   # SINGLE SPACE BEGINNING OR END
 dplyr::mutate(merge_exp=1)
  
  
 temp_sige_match.final <- dplyr::bind_rows(temp_sige_match,  temp_sige_match.expanded)  %>%
                       dplyr::mutate_at(c('merge_exp'), ~replace_na(.,0))
 
 temp_sige_match.final <- temp_sige_match.final %>% dplyr::mutate(match_var = ifelse(occurence == 1, match_var_trimmed, match_var)) 
 
 temp_sige_match.final$match_var <- as.character(temp_sige_match.final$match_var)
 
# Take all schools without any numbers and add digits up to 
 temp_sige_match.final.exp <- temp_sige_match.final %>% dplyr::filter(!str_detect(match_var,"[0-9]")) %>% dplyr::mutate(nums = 1)
 temp_sige_match.final.exp <- temp_sige_match.final.exp[rep(row.names(temp_sige_match.final.exp), ifelse(temp_sige_match.final.exp$nums==1, 8, 1)), ] %>% group_by(match_var) %>% dplyr::mutate(ind.exp = row_number())
 
temp_sige_match.final.exp$match_var <- paste(temp_sige_match.final.exp$match_var,temp_sige_match.final.exp$ind.exp)

temp_sige_match.final.exp <- temp_sige_match.final.exp %>%  dplyr::mutate_at(.vars=vars(match_var), list(~ gsub("\\s\\s", " ", .))) %>% # DOUBLE SPACE
         dplyr::mutate_at(.vars=vars(match_var), list(~ gsub("^\\s|\\s$", "", .)))  %>%  # SINGLE SPACE BEGINNING OR END
         dplyr::mutate(match_var = gsub("[[:blank:]]", "", match_var))
  
  temp_sige_match.final.digits <- dplyr::bind_rows(temp_sige_match.final,  temp_sige_match.final.exp) 
 
 matching <- left_join(temp_ceni_small_villes_match,temp_sige_match.final.digits, by = "match_var") 
 
 assign(s, matching)
}


a = ls()
index = which(str_detect(a, "[[:upper:]]"))
b = a[index]
matching_binded <- do.call(bind_rows, lapply(b, get, env=environment()))
```

Within the loop, first I filter the \textit{town_province} names. Then I create a 10 km buffer around the coordinates. I join the sigeschools and buffer shapefiles, I identify the schools falling within each locality's buffer. Afterwards, I count the school names without the school type and for single observations, I create additional school types and store them in the \textit{temp_sige_match.expanded} dataframe. I append the extended dataset with the initial one without duplicates in the \textit{temp_sige_match.final} dataset. Afterwards, I pick all the schools without any numbers at the end, and create additional school names for these by adding digits up to 8. This procedure allows us to capture some schools which has a digit at the end in the CENI dataset, but not in SIGE. In fact, when I added this additional step to the loop the matching performance that I calculate below has increased by 3-4 percentage points. 

### 6. Statistics - Voting Stations
Below are the statistics for voting stations which are schools. Number of voting stations in the first graph is for small localities where voting stations' number is greater than 10. I'm also giving the statistics for brackets in Graph 4.
```{r echo = FALSE, out.width="50%"}
# Number of voting stations by commune in CENI raw data
ceni_voting_raw <- cenischools.all %>%
  group_by(town_province) %>% 
  add_count(name = "voting_stations") %>%
  dplyr::distinct(town_province, .keep_all = TRUE) %>%
  #dplyr::select(c("town_province", "voting_stations")) %>%
  dplyr::arrange(as.numeric(voting_stations)) %>%
  dplyr::filter(voting_stations > 10)
  
plot0 <- barplot(height=ceni_voting_raw$voting_stations, names.arg=ceni_voting_raw$town_province,las=2, cex.names=0.4,col="cornflowerblue",ylim=c(0,30), main="Number of Voting Stations by Small Localities in the CENI Raw Data", cex=0.5)
text(x = plot0, y = ceni_voting_raw$voting_stations, label = ceni_voting_raw$voting_stations, pos = 3 , cex = 0.6, col = "black")

ceni_voting_raw_count <- cenischools.all %>%
  group_by(town_province) %>% 
  add_count(name = "voting_stations") %>%
  dplyr::distinct(town_province, .keep_all = TRUE) %>%
  #dplyr::select(c("town_province", "voting_stations")) %>%
  dplyr::arrange(as.numeric(voting_stations)) %>%
  group_by(voting_stations) %>%
  add_count(name = "counts") %>%
  dplyr::distinct(voting_stations, .keep_all = TRUE)

plot1 <- barplot(height=ceni_voting_raw_count$counts, names.arg=ceni_voting_raw_count$voting_stations,las=2, cex.names=0.6,col="cornflowerblue",ylim=c(0,35), main="Number of Localities by Their Voting Stations in the CENI Raw Data", xlab="Number of Voting Stations", ylab="Count of Localities", cex=0.5)
text(x = plot1, y = ceni_voting_raw_count$counts, label = ceni_voting_raw_count$counts, pos = 3 , cex = 0.6, col = "black")


# Distribution of schools which are voting stations in big cities
matching_dist <- matching_binded %>%
  dplyr::mutate(ep = ifelse(str_detect(ceni_nom_sv, 
                                       "ECOLEPRIMAIRE"), 1, 0)) %>%  # ECOLE PRIMAIRE
  dplyr::mutate(em = ifelse(str_detect(ceni_nom_sv,
                                       "ECOLEMATERNELLE"), 1, 0)) %>% # ECOLE MATERNELLLE
  dplyr::mutate(cs = ifelse(str_detect(ceni_nom_sv, 
                                       "COMPLEXESCOLAIRE"), 1, 0)) %>% # COMPLEXE SCOLAIRE
  dplyr::mutate(gs = ifelse(str_detect(ceni_nom_sv, 
                                       "GROUPESCOLAIRE"), 1, 0)) %>% # GROUPE SCOLAIRE
  dplyr::mutate(col = ifelse(str_detect(ceni_nom_sv, 
                                        "COLLEGE"), 1, 0)) %>% # COLLEGE
  dplyr::mutate(lyc = ifelse(str_detect(ceni_nom_sv, 
                                        "LYCEE"), 1, 0)) %>% # LYCEE
  dplyr::mutate(inst = ifelse(str_detect(ceni_nom_sv, 
                                         "INSTITUT|INSTITUT TECHNIQUE PROFESSIONNEL|
                                         INSTITUT TECHNIQUE COMMERCIAL INDUSTRIEL|
                                         INSTITUT TECHNIQUE COMMERCIAL|
                                         INSTITUT TECHNIQUE|
                                         INSTITUT TECHNIQUE COMMERCIAL INDUSTRIEL|
                                         SCIENTIFIQUE SOCIAL|
                                         INSTITUT TECHNIQUE COMMERICAL ADMINISTRATION DE TELY|
                                         INSTITUT TECHNIQUE METEO AVIATION|
                                         INSTITUT TECHNIQUE METEO|
                                         INSTITUT TECHNIQUE AGRICOLE VETERINAIRE|
                                         INSTITUT TECHNIQUE AGRICOLE|
                                         INSTITUT TECHNIQUE VETERINAIRE|
                                         INSTITUT AGRO FORESTERIE|
                                         INSTITUT TECHNIQUE AGRICOLE PROFESSIONNEL|
                                         INSTITUT TECHNIQUE MEDICAL CHRETIEN|
                                         INSTITUT SUPERIEUR TECHNOLOGIQUE DE KINSHASA"), 1, 0)) %>% # INST
   dplyr::mutate(ac = ifelse(str_detect(ceni_nom_sv, "ACADEMIE"), 1, 0)) %>% # ACADEMIE
 mutate(tot_ecole = select(., ep:ac) %>% rowSums(na.rm = TRUE)) %>%  dplyr::mutate(others = ifelse(tot_ecole !=1, 1, 0))



df <- matching_dist %>% dplyr::summarise(across(c(ep, em, cs, gs, col, lyc, inst, ac), sum)) %>% pivot_longer(cols=everything(), names_to='school_type', values_to='count') %>% arrange(count) #collapse sum and reshape long
df$school_type[df$school_type == "ep"] <- "Ecole Primaire"
df$school_type[df$school_type == "em"] <- "Ecole Maternelle"
df$school_type[df$school_type == "cs"] <- "Comp. Scolaire"
df$school_type[df$school_type == "gs"] <- "Groupe Scolaire"
df$school_type[df$school_type == "col"] <- "College"
df$school_type[df$school_type == "lyc"] <- "Lycee"
df$school_type[df$school_type == "inst"] <- "Institut"
df$school_type[df$school_type == "ac"] <- "Academie"

p <- barplot(height=df$count, names.arg=df$school_type, las=2, cex.names=0.6, col="cornflowerblue", ylim=c(0,750), main="Voting Stations/Schools in Small Localities by School Type (with dups)")
text(x = p, y = df$count, label = df$count, pos = 3 , cex = 0.8, col = "black")

#############################################################################
######################## BRACKETS ###########################################
#############################################################################

ceni_voting_raw <- cenischools.all %>%
  group_by(town_province) %>% 
  add_count(name = "voting_stations") %>%
  dplyr::distinct(town_province, .keep_all = TRUE) %>%
  #dplyr::select(c("town_province", "voting_stations")) %>%
  dplyr::arrange(as.numeric(voting_stations)) %>%
  dplyr::mutate(bracket = ifelse(voting_stations>=1 & voting_stations<=5, "[1-5]", ifelse(voting_stations>=6 & voting_stations<=10, "[6-10]", ifelse(voting_stations>=11 & voting_stations<=15, "[11-15]", ifelse(voting_stations>=16 & voting_stations<=18, "[16-18]", ifelse(voting_stations==21, "21", ifelse(voting_stations==23, "23", ifelse(voting_stations==26, "26", "" )))))))) %>%
  group_by(bracket) %>%
  add_count(name = "bracket_count") %>%
  dplyr::distinct(bracket, .keep_all = TRUE)


plot2 <- barplot(height=ceni_voting_raw$bracket_count, names.arg=ceni_voting_raw$bracket,las=2, cex.names=0.6,col="darkseagreen",ylim=c(0,120), main="No of Localities by Their Voting Stations in the CENI Raw Data (Bracket)", xlab="Number of Voting Stations as  Brackets", ylab="Count of Localities", cex=0.5)
text(x = plot2, y = ceni_voting_raw$bracket_count, label = ceni_voting_raw$bracket_count, pos = 3 , cex = 0.6, col = "black")

  
```


### 7. Matching

Below, I filter out the observations for which there is no georeference. The dataframe georeference_villes gives the observations for which we are able to successfully perform matching.

```{r}
expost_check <- matching_binded %>%
  dplyr::filter(!is.na(as.numeric(latitude))) %>%
  dplyr::distinct(match_var, .keep_all = TRUE)

georeference_villes <- matching_binded %>%
  #dplyr::select(c(ceni_site_vote_ID,latitude, longitude)) %>%
  dplyr::filter(!is.na(latitude)) %>%
  dplyr::mutate(source = "small_locs")

matching_filtered <- matching_binded %>% dplyr::filter(is.na(latitude)) 
matching_filtered_wo_dup <- matching_filtered %>% dplyr::filter(!str_detect(match_var, "ACADEMIE")) %>% distinct(ceni_site_vote_ID, circonscription, latitude, .keep_all=TRUE)

x <- nrow(georeference_villes)
y <- nrow(matching_binded)
z <- nrow(matching_filtered) - nrow(matching_filtered_wo_dup)

matching_performance <- x/(y-z)*100
matching_performance

library(writexl)
write_xlsx(georeference_villes, paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "output")),'georeference_small.xlsx', sep="/"))
#write_xlsx(georeference_villes, "georeference_small.xlsx")

```
While calculating the matching performance, I remove the duplicate schools which I created earlier while cleaning the data. Based on the calculations, the matching performance for 10 km buffer is `r matching_performance`$\%$. In total,  there are `r y-z`voting stations which are schools and we are able to georeference `r x` of them. 

### 8. Statistics - Matching

Below, I'm providing graphs at three different levels: small locality, commune and province. In the first graph, I'm graphing only the small localities where the number of matched voting stations by town_province is greater than or equal to 6. We see how the distribution over these small localities are in blocks. That's why I'm providing other graphs at the commune and province level as well.

```{r echo = FALSE, out.width="50%"}
# Number of matches by town_province
commune_dist <- georeference_villes %>% 
  group_by(town_province) %>% 
  add_count(name = "number" ) %>%
  mutate(percent = number/nrow(georeference_villes)*100) %>%
  distinct(town_province, .keep_all=TRUE) %>%
  arrange(number) %>%
  filter(number >=6)

p <- barplot(height=commune_dist$number, names.arg=commune_dist$town_province, las=2, cex.names=0.45, col="cornflowerblue", ylim=c(0,20), main="Georeference by Small Locality (Count)")
text(x = p, y = commune_dist$number, label = commune_dist$number, pos = 3 , cex = 0.8, col = "black")

commune_dist_ <- georeference_villes %>% 
  group_by(town_province) %>% 
  add_count(name = "number" ) %>%
  mutate(percent = number/nrow(georeference_villes)*100) %>%
  distinct(town_province, .keep_all=TRUE) %>%
  arrange(number) %>%
  filter(percent > 0)

p <- barplot(height=commune_dist_$percent, names.arg=commune_dist_$town_province, las=2, cex.names=0.6, col="cornflowerblue", ylim=c(0,3), main="Georeference by Small Locality (Percentage)")

# Matching Performance by town_province
commune_tot <- matching_binded %>%
  group_by(town_province) %>%
  add_count(name = "tot") %>%
  distinct(town_province, .keep_all=TRUE) %>%
  dplyr::select(c('town_province', 'tot'))

commune_matching <- georeference_villes %>% 
  group_by(town_province) %>% 
  add_count(name = "number" ) %>%
  distinct(town_province, .keep_all=TRUE) %>%
  dplyr::select(c('town_province','number'))

commune_performance <- left_join(commune_matching, commune_tot, by='town_province' )
commune_performance <- commune_performance %>% dplyr::mutate(share = number/tot*100) %>%
  arrange(share)

p <- barplot(height=commune_performance$share, names.arg=commune_performance$town_province, las=2, cex.names=0.6, col="cornflowerblue", ylim=c(0,100), main="Matching Performance by Small Locality (Percent)")





#############################################################################
######################## COMMUNE ###########################################
#############################################################################

# Number of matches by town_province
commune_dist <- georeference_villes %>% 
  group_by(ceni_sect_chef_comm) %>% 
  add_count(name = "number" ) %>%
  mutate(percent = number/nrow(georeference_villes)*100) %>%
  distinct(ceni_sect_chef_comm, .keep_all=TRUE) %>%
  arrange(number)

p <- barplot(height=commune_dist$number, names.arg=commune_dist$ceni_sect_chef_comm, las=2, cex.names=0.6, col="coral1", ylim=c(0,15), main="Georeference by Commune (Count)")


commune_dist_ <- georeference_villes %>% 
  group_by(ceni_sect_chef_comm) %>% 
  add_count(name = "number" ) %>%
  mutate(percent = number/nrow(georeference_villes)*100) %>%
  distinct(ceni_sect_chef_comm, .keep_all=TRUE) %>%
  arrange(number)

p <- barplot(height=commune_dist_$percent, names.arg=commune_dist_$ceni_sect_chef_comm, las=2, cex.names=0.6, col="coral1", ylim=c(0,5), main="Georeference by Commune (Percentage)")

# Matching Performance by town_province
commune_tot <- matching_binded %>%
  group_by(ceni_sect_chef_comm) %>%
  add_count(name = "tot") %>%
  distinct(ceni_sect_chef_comm, .keep_all=TRUE) %>%
  dplyr::select(c('ceni_sect_chef_comm', 'tot'))

commune_matching <- georeference_villes %>% 
  group_by(ceni_sect_chef_comm) %>% 
  add_count(name = "number" ) %>%
  distinct(ceni_sect_chef_comm, .keep_all=TRUE) %>%
  dplyr::select(c('ceni_sect_chef_comm','number'))

commune_performance <- left_join(commune_matching, commune_tot, by='ceni_sect_chef_comm' )
commune_performance <- commune_performance %>% dplyr::mutate(share = number/tot*100) %>%
  arrange(share)

p <- barplot(height=commune_performance$share, names.arg=commune_performance$ceni_sect_chef_comm, las=2, cex.names=0.6, col="coral1", ylim=c(0,100), main="Matching Performance by Commune (Percent)")

#############################################################################
######################## PROVINCE ###########################################
#############################################################################

# Number of matches by town_province
commune_dist <- georeference_villes %>% 
  group_by(province) %>% 
  add_count(name = "number" ) %>%
  mutate(percent = number/nrow(georeference_villes)*100) %>%
  distinct(province, .keep_all=TRUE) %>%
  arrange(number)

p <- barplot(height=commune_dist$number, names.arg=commune_dist$province, las=2, cex.names=0.6, col="darkseagreen", ylim=c(0,60), main="Georeference by Province (Count)")
text(x = p, y = commune_dist$number, label = commune_dist$number, pos = 3 , cex = 0.8, col = "black")

commune_dist_ <- georeference_villes %>% 
  group_by(province) %>% 
  add_count(name = "number" ) %>%
  mutate(percent = number/nrow(georeference_villes)*100) %>%
  distinct(province, .keep_all=TRUE) %>%
  arrange(number)

p <- barplot(height=commune_dist_$percent, names.arg=commune_dist_$province, las=2, cex.names=0.6, col="darkseagreen", ylim=c(0,15), main="Georeference by Province (Percentage)")

# Matching Performance by town_province
commune_tot <- matching_binded %>%
  group_by(province) %>%
  add_count(name = "tot") %>%
  distinct(province, .keep_all=TRUE) %>%
  dplyr::select(c('province', 'tot'))

commune_matching <- georeference_villes %>% 
  group_by(province) %>% 
  add_count(name = "number" ) %>%
  distinct(province, .keep_all=TRUE) %>%
  dplyr::select(c('province','number'))

commune_performance <- left_join(commune_matching, commune_tot, by='province' )
commune_performance <- commune_performance %>% dplyr::mutate(share = number/tot*100) %>%
  arrange(share)

p <- barplot(height=commune_performance$share, names.arg=commune_performance$province, las=2, cex.names=0.6, col="darkseagreen", ylim=c(0,100), main="Matching Performance by Province (Percent)")


```

### 9. Mapping
Below, the first map shows the georeference for matched voting stations in small localities. In the second map, I'm overlaying the georeference I previously conducted for Big Villes and Kinshasa:

```{r echo=FALSE, fig.align='center', out.width="65%"}
shp <- read_sf(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "maps/congo")),'COD_adm0.shp', sep="/"))
georeference_shp1 <- st_as_sf(georeference_villes, coords = c("longitude", "latitude"), 
                                    crs = 4326)
map1 <- tm_shape(shp) + tm_fill(col = "grey85") +
 tm_borders(col="white", lwd = 1) +
tm_shape(georeference_shp1) + tm_dots(col="cornflowerblue", shape = 18, size =.2, title = "Voting Stations") +
  tm_credits("Matched Voting Stations",
             position = c("LEFT", "BOTTOM")) +
  tm_compass() + 
  tm_scale_bar() +
  tm_layout(frame = FALSE, 
            legend.outside = FALSE,
            legend.show = TRUE) 
map1



georeference_bigvilles <- read_xlsx(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "output")),'georeference_bigcities_15km.xlsx', sep="/"))

georeference_shp2 <- st_as_sf(georeference_bigvilles, coords = c("longitude", "latitude"), 
                                    crs = 4326)

map2 <- map1 + tm_shape(georeference_shp2)  + tm_dots(col="red", shape = 18, size =.2) 


georeference_kinshasa <- read_xlsx(paste((file.path(here::here(current_path) %>% dirname() %>% dirname(), "output")),'georeference_kinshasa.xlsx', sep="/"))

georeference_shp3 <- st_as_sf(georeference_kinshasa , coords = c("longitude", "latitude"), 
                                    crs = 4326)

map3 <- map2 + tm_shape(georeference_shp3)  + tm_dots(col="green", shape = 18, size =.2) + tm_add_legend('symbol', col=c("cornflowerblue", 'red', 'green'),labels =c('Small Localities', 'Big Cities', 'Kinshasa'))

map3
```




```{r eval=FALSE, include=FALSE}
sigeschools.all$NomEcole <- str_replace_all(sigeschools.all$NomEcole, fixed(" "), "")

#sigeschools.all <- sigeschools.all %>% dplyr::select(c("NomEcole", "GPS_longitude", "GPS_latitude", "latitude", "longitude", "ProvincePoliAdmin", "Proved"    ,"Sproved","Territoire"))

## Change the province name to create a matching var (22/02)

#sigeschools.all <- sigeschools.all %>% dplyr::mutate_at(.vars=vars(ProvincePoliAdmin), list(~ gsub("-", " ", .)))

# Extract villes in the SIGE data
sigeschools.all <- sigeschools.all %>%
   dplyr::filter(ProvincePoliAdmin != "KINSHASA") %>%
   dplyr::filter(!str_detect(Territoire,"\\sVILLE")) #%>%
   #dplyr::mutate_at(.vars=vars(Territoire), list(~ gsub(" ", "", .))) %>%
   #dplyr::mutate(town_province = paste0(Territoire,ProvincePoliAdmin)) %>%
   #dplyr::mutate(town_province = gsub("[[:blank:]]", "", town_province))


sigeschools.all_sf = st_as_sf(sigeschools.all, coords = c("GPS_longitude", "GPS_latitude"), 
                                    crs = 4326)

cenischools.all_sf = st_as_sf(ceni_small_villes_match, crs=4326) 


small_villes <- unique(ceni_small_villes_match$town_province)


for(s in small_villes) {
  # temp_villes_sf <- cenischools.all_sf %>%
  #   dplyr::filter(ceni_sect_chef_comm == s) 
  
  temp_villes_sf <- towns_gps %>%
    dplyr::filter(town_province == s)
  
  temp_ceni_small_villes_match <- ceni_small_villes_match %>%   dplyr::filter(ceni_small_villes_match$town_province == s)
  
  temp_villes_sf_buffer_10km <- st_buffer(temp_villes_sf, 10000)
  
  # Identify schools falling within city's buffer
  sigeschools.all_sf_admin <- st_join(sigeschools.all_sf,  temp_villes_sf_buffer_10km, left=FALSE) %>%
    #dplyr::filter(!is.na(town_province)) %>%
    #dplyr::distinct(NomEcole, geometry, .keep_all = TRUE) %>%
    dplyr::distinct(NomEcole, town_province.x, .keep_all = TRUE) # HERE I REMOVE DUPLICATE WITHIN SAME VILLE
  
    # Generate Matching Variable SIGE
  temp_sige_match <- sigeschools.all_sf_admin %>%
    dplyr::mutate(match_var = paste(NomEcole)) %>%
    dplyr::mutate(match_var = str_replace_all(match_var, fixed(" "), "")) %>%
    #dplyr::filter(ProvincePoliAdmin == s) %>% ##?
    dplyr::select(c("match_var","latitude","longitude", "Territoire")) %>%
    dplyr::mutate(info = NA)
  
  temp_sige_match <- temp_sige_match %>% 
    dplyr::mutate(match_var_trimmed = match_var) %>%
    dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("COMPLEXESCOLAIRE|ECOLEMATERNELLE|COLLEGE|ECOLEPRIMAIRE|LYCEE|INSTITUT|INSTITUTSCIENTIFIQUE|INSTITUTTECHNIQUEAGRICOLE|INSTITUTTECHNIQUEPROFESSIONNEL|INSTITUTTECHNOLOGIQUE|GROUPESCOLAIRE|ACADEMIE", "", .))) %>%  # remove school types
    group_by(match_var_trimmed) %>% add_count(name = "occurence") 
  
# Take all the 1 occurences and add other school types in here
  temp_sige_match.expanded <- temp_sige_match[rep(row.names(temp_sige_match), ifelse(temp_sige_match$occurence==1, 8, 1)), ] %>%
    group_by(match_var_trimmed) %>% dplyr::mutate(ind = row_number()) %>% filter(occurence == 1)

  temp_sige_match.expanded$match_var_trimmed <- paste(temp_sige_match.expanded$ind, temp_sige_match.expanded$match_var_trimmed)
  
 temp_sige_match.expanded<- temp_sige_match.expanded %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(1)\\s+(*.)", "ECOLEPRIMAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(2)\\s+(*.)", " ECOLEMATERNELLE\\2", .))) %>% 
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(3)\\s+(*.)", " COLLEGE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(4)\\s+(*.)", " LYCEE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(5)\\s+(*.)", " INSTITUT\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(6)\\s+(*.)", " GROUPESCOLAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(7)\\s+(*.)", " COMPLEXESCOLAIRE\\2", .))) %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(8)\\s+(*.)", " ACADEMIE\\2", .))) %>%
        dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("\\s\\s", " ", .))) %>% # DOUBLE SPACE
         dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("^\\s|\\s$", "", .))) %>%   # SINGLE SPACE BEGINNING OR END
 dplyr::mutate(merge_exp=1)
  
  
 temp_sige_match.final <- dplyr::bind_rows(temp_sige_match,  temp_sige_match.expanded)  %>%
                       dplyr::mutate_at(c('merge_exp'), ~replace_na(.,0))
 
 temp_sige_match.final <- temp_sige_match.final %>% dplyr::mutate(match_var = ifelse(occurence == 1, match_var_trimmed, match_var)) 
 
 temp_sige_match.final$match_var <- as.character(temp_sige_match.final$match_var)
 matching <- left_join(temp_ceni_small_villes_match,temp_sige_match.final, by = "match_var") 
 
 assign(s, matching)
}

a = ls()
index = which(str_detect(a, "[[:upper:]]"))
b = a[index]
matching_binded <- do.call(bind_rows, lapply(b, get, env=environment()))

```
```{r eval=FALSE, include=FALSE}
remove(list=b)
ceni_small_villes_match <- filter(cenischools.all, ceni_site_vote_ID %in% matching_filtered$ceni_site_vote_ID )

 ceni_small_villes_match <-  ceni_small_villes_match %>%
  dplyr::select(c("ceni_site_vote_ID","ceni_nom_sv","province","ceni_sect_chef_comm", "circonscription", "town_province", "geometry")) %>%
  dplyr::mutate(match_var = paste(ceni_nom_sv)) %>%
  dplyr::mutate(match_var = str_replace_all(match_var, fixed(" "), ""))
 
 cenischools.all_sf = st_as_sf(ceni_small_villes_match, crs=4326) 
 
 small_villes <- unique(ceni_small_villes_match$ceni_sect_chef_comm)


for(s in small_villes) {
  temp_villes_sf <- cenischools.all_sf %>%
    dplyr::filter(ceni_sect_chef_comm == s)
  # 
  # temp_villes_sf <- towns_gps %>%
  #   dplyr::filter(name== s)
  
  temp_ceni_small_villes_match <- ceni_small_villes_match %>%   dplyr::filter(ceni_small_villes_match$ceni_sect_chef_comm == s)
  
  temp_villes_sf_buffer_10km <- st_buffer(temp_villes_sf, 10000)
  
  # Identify schools falling within city's buffer
  sigeschools.all_sf_admin <- st_join(sigeschools.all_sf,  temp_villes_sf_buffer_10km, left=FALSE) %>%
    #dplyr::filter(!is.na(town_province)) %>%
    #dplyr::distinct(NomEcole, geometry, .keep_all = TRUE) %>%
    dplyr::distinct(NomEcole, town_province.x, .keep_all = TRUE) # HERE I REMOVE DUPLICATE WITHIN SAME VILLE
  
    # Generate Matching Variable SIGE
  temp_sige_match <- sigeschools.all_sf_admin %>%
    dplyr::mutate(match_var = paste(NomEcole)) %>%
    dplyr::mutate(match_var = str_replace_all(match_var, fixed(" "), "")) %>%
    #dplyr::filter(ProvincePoliAdmin == s) %>% ##?
    dplyr::select(c("match_var","latitude","longitude", "Territoire")) %>%
    dplyr::mutate(info = NA)
  
  temp_sige_match <- temp_sige_match %>% 
    dplyr::mutate(match_var_trimmed = match_var) %>%
    dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("COMPLEXESCOLAIRE|ECOLEMATERNELLE|COLLEGE|ECOLEPRIMAIRE|LYCEE|INSTITUT|INSTITUTSCIENTIFIQUE|INSTITUTTECHNIQUEAGRICOLE|INSTITUTTECHNIQUEPROFESSIONNEL|INSTITUTTECHNOLOGIQUE|GROUPESCOLAIRE|ACADEMIE", "", .))) %>%  # remove school types
    group_by(match_var_trimmed) %>% add_count(name = "occurence") 
  
# Take all the 1 occurences and add other school types in here
  temp_sige_match.expanded <- temp_sige_match[rep(row.names(temp_sige_match), ifelse(temp_sige_match$occurence==1, 8, 1)), ] %>%
    group_by(match_var_trimmed) %>% dplyr::mutate(ind = row_number()) %>% filter(occurence == 1)

  temp_sige_match.expanded$match_var_trimmed <- paste(temp_sige_match.expanded$ind, temp_sige_match.expanded$match_var_trimmed)
  
 temp_sige_match.expanded<- temp_sige_match.expanded %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(1)\\s+(*.)", "ECOLEPRIMAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(2)\\s+(*.)", " ECOLEMATERNELLE\\2", .))) %>% 
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(3)\\s+(*.)", " COLLEGE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(4)\\s+(*.)", " LYCEE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(5)\\s+(*.)", " INSTITUT\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(6)\\s+(*.)", " GROUPESCOLAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(7)\\s+(*.)", " COMPLEXESCOLAIRE\\2", .))) %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(8)\\s+(*.)", " ACADEMIE\\2", .))) %>%
        dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("\\s\\s", " ", .))) %>% # DOUBLE SPACE
         dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("^\\s|\\s$", "", .))) %>%   # SINGLE SPACE BEGINNING OR END
 dplyr::mutate(merge_exp=1)
  
  
 temp_sige_match.final <- dplyr::bind_rows(temp_sige_match,  temp_sige_match.expanded)  %>%
                       dplyr::mutate_at(c('merge_exp'), ~replace_na(.,0))
 
 temp_sige_match.final <- temp_sige_match.final %>% dplyr::mutate(match_var = ifelse(occurence == 1, match_var_trimmed, match_var)) 
 
 temp_sige_match.final$match_var <- as.character(temp_sige_match.final$match_var)
 matching <- left_join(temp_ceni_small_villes_match,temp_sige_match.final, by = "match_var") 
 
 # Take all schools without any numbers
 temp_sige_match.final.exp <- temp_sige_match.final %>% dplyr::filter(!str_detect(match_var,"[0-9]")) %>% dplyr::mutate(nums = 1)
 temp_sige_match.final.exp <- temp_sige_match.final.exp[rep(row.names(temp_sige_match.final.exp), ifelse(temp_sige_match.final.exp$nums==1, 8, 1)), ] %>% group_by(match_var) %>% dplyr::mutate(ind.exp = row_number())
 
temp_sige_match.final.exp$match_var <- paste(temp_sige_match.final.exp$match_var,temp_sige_match.final.exp$ind.exp)

temp_sige_match.final.exp <- temp_sige_match.final.exp %>%  dplyr::mutate_at(.vars=vars(match_var), list(~ gsub("\\s\\s", " ", .))) %>% # DOUBLE SPACE
         dplyr::mutate_at(.vars=vars(match_var), list(~ gsub("^\\s|\\s$", "", .)))  %>%  # SINGLE SPACE BEGINNING OR END
         dplyr::mutate(match_var = gsub("[[:blank:]]", "", match_var))
  
  temp_sige_match.final.digits <- dplyr::bind_rows(temp_sige_match.final,  temp_sige_match.final.exp) 
 
 matching <- left_join(temp_ceni_small_villes_match,temp_sige_match.final.digits, by = "match_var") 
 
 assign(s, matching)
}

 a = ls()
index = which(str_detect(a, "[[:upper:]]"))
b = a[index]
matching_binded_2 <- do.call(bind_rows, lapply(b, get, env=environment()))

expost_check_2 <- matching_binded_2 %>%
  dplyr::filter(!is.na(as.numeric(latitude))) %>%
  dplyr::distinct(match_var, .keep_all = TRUE)

georeference_villes_2 <- matching_binded_2 %>%
  #dplyr::select(c(ceni_site_vote_ID.x,latitude, longitude)) %>%
  dplyr::filter(!is.na(latitude)) %>%
  dplyr::mutate(source = "SIGE")

matching_filtered_2 <- matching_binded_2 %>% dplyr::filter(is.na(latitude)) 
matching_filtered_wo_dup_2 <- matching_filtered_2 %>% dplyr::filter(!str_detect(match_var, "ACADEMIE")) %>% distinct(ceni_site_vote_ID, circonscription, latitude, .keep_all=TRUE)

x_2 <- nrow(georeference_villes_2)
y_2 <- nrow(matching_binded_2)
z_2 <- nrow(matching_filtered_2) - nrow(matching_filtered_wo_dup_2)

matching_performance_2 <- x_2/(y_2-z_2)*100
matching_performance_2


```
```{r eval=FALSE, include=FALSE}
remove(list=b)
ceni_small_villes_match <- filter(cenischools.all, ceni_site_vote_ID %in% matching_filtered$ceni_site_vote_ID )

 ceni_small_villes_match <-  ceni_small_villes_match %>%
  dplyr::select(c("ceni_site_vote_ID","ceni_nom_sv","province","ceni_sect_chef_comm", "circonscription", "town_province", "geometry")) %>%
  dplyr::mutate(match_var = paste(ceni_nom_sv)) %>%
  dplyr::mutate(match_var = str_replace_all(match_var, fixed(" "), ""))
 
 cenischools.all_sf = st_as_sf(ceni_small_villes_match, crs=4326) 
 
 small_villes <- unique(ceni_small_villes_match$circonscription)


for(s in small_villes) {
  # temp_villes_sf <- cenischools.all_sf %>%
  #   dplyr::filter(ceni_sect_chef_comm == s) 
  
  temp_villes_sf <- towns_gps %>%
    dplyr::filter(name== s)
  
  temp_ceni_small_villes_match <- ceni_small_villes_match %>%   dplyr::filter(ceni_small_villes_match$circonscription == s)
  
  temp_villes_sf_buffer_10km <- st_buffer(temp_villes_sf, 10000)
  
  # Identify schools falling within city's buffer
  sigeschools.all_sf_admin <- st_join(sigeschools.all_sf,  temp_villes_sf_buffer_10km, left=FALSE) %>%
    #dplyr::filter(!is.na(town_province)) %>%
    #dplyr::distinct(NomEcole, geometry, .keep_all = TRUE) %>%
    dplyr::distinct(NomEcole, town_province.x, .keep_all = TRUE) # HERE I REMOVE DUPLICATE WITHIN SAME VILLE
  
    # Generate Matching Variable SIGE
  temp_sige_match <- sigeschools.all_sf_admin %>%
    dplyr::mutate(match_var = paste(NomEcole)) %>%
    dplyr::mutate(match_var = str_replace_all(match_var, fixed(" "), "")) %>%
    #dplyr::filter(ProvincePoliAdmin == s) %>% ##?
    dplyr::select(c("match_var","latitude","longitude", "Territoire")) %>%
    dplyr::mutate(info = NA)
  
  temp_sige_match <- temp_sige_match %>% 
    dplyr::mutate(match_var_trimmed = match_var) %>%
    dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("COMPLEXESCOLAIRE|ECOLEMATERNELLE|COLLEGE|ECOLEPRIMAIRE|LYCEE|INSTITUT|INSTITUTSCIENTIFIQUE|INSTITUTTECHNIQUEAGRICOLE|INSTITUTTECHNIQUEPROFESSIONNEL|INSTITUTTECHNOLOGIQUE|GROUPESCOLAIRE|ACADEMIE", "", .))) %>%  # remove school types
    group_by(match_var_trimmed) %>% add_count(name = "occurence") 
  
# Take all the 1 occurences and add other school types in here
  temp_sige_match.expanded <- temp_sige_match[rep(row.names(temp_sige_match), ifelse(temp_sige_match$occurence==1, 8, 1)), ] %>%
    group_by(match_var_trimmed) %>% dplyr::mutate(ind = row_number()) %>% filter(occurence == 1)

  temp_sige_match.expanded$match_var_trimmed <- paste(temp_sige_match.expanded$ind, temp_sige_match.expanded$match_var_trimmed)
  
 temp_sige_match.expanded<- temp_sige_match.expanded %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(1)\\s+(*.)", "ECOLEPRIMAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(2)\\s+(*.)", " ECOLEMATERNELLE\\2", .))) %>% 
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(3)\\s+(*.)", " COLLEGE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(4)\\s+(*.)", " LYCEE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(5)\\s+(*.)", " INSTITUT\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(6)\\s+(*.)", " GROUPESCOLAIRE\\2", .))) %>%  
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(7)\\s+(*.)", " COMPLEXESCOLAIRE\\2", .))) %>%
  dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("(8)\\s+(*.)", " ACADEMIE\\2", .))) %>%
        dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("\\s\\s", " ", .))) %>% # DOUBLE SPACE
         dplyr::mutate_at(.vars=vars(match_var_trimmed), list(~ gsub("^\\s|\\s$", "", .))) %>%   # SINGLE SPACE BEGINNING OR END
 dplyr::mutate(merge_exp=1)
  
  
 temp_sige_match.final <- dplyr::bind_rows(temp_sige_match,  temp_sige_match.expanded)  %>%
                       dplyr::mutate_at(c('merge_exp'), ~replace_na(.,0))
 
 temp_sige_match.final <- temp_sige_match.final %>% dplyr::mutate(match_var = ifelse(occurence == 1, match_var_trimmed, match_var)) 
 
 temp_sige_match.final$match_var <- as.character(temp_sige_match.final$match_var)
 matching <- left_join(temp_ceni_small_villes_match,temp_sige_match.final, by = "match_var") 
 
# Take all schools without any numbers
 temp_sige_match.final.exp <- temp_sige_match.final %>% dplyr::filter(!str_detect(match_var,"[0-9]")) %>% dplyr::mutate(nums = 1)
 temp_sige_match.final.exp <- temp_sige_match.final.exp[rep(row.names(temp_sige_match.final.exp), ifelse(temp_sige_match.final.exp$nums==1, 8, 1)), ] %>% group_by(match_var) %>% dplyr::mutate(ind.exp = row_number())
 
temp_sige_match.final.exp$match_var <- paste(temp_sige_match.final.exp$match_var,temp_sige_match.final.exp$ind.exp)

temp_sige_match.final.exp <- temp_sige_match.final.exp %>%  dplyr::mutate_at(.vars=vars(match_var), list(~ gsub("\\s\\s", " ", .))) %>% # DOUBLE SPACE
         dplyr::mutate_at(.vars=vars(match_var), list(~ gsub("^\\s|\\s$", "", .)))  %>%  # SINGLE SPACE BEGINNING OR END
         dplyr::mutate(match_var = gsub("[[:blank:]]", "", match_var))
  
  temp_sige_match.final.digits <- dplyr::bind_rows(temp_sige_match.final,  temp_sige_match.final.exp) 
 
 matching <- left_join(temp_ceni_small_villes_match,temp_sige_match.final.digits, by = "match_var") 
 
 assign(s, matching)
}

 a = ls()
index = which(str_detect(a, "[[:upper:]]"))
b = a[index]
matching_binded_3 <- do.call(bind_rows, lapply(b, get, env=environment()))

expost_check_3 <- matching_binded_3 %>%
  dplyr::filter(!is.na(as.numeric(latitude))) %>%
  dplyr::distinct(match_var, .keep_all = TRUE)

georeference_villes_3 <- matching_binded_3 %>%
  #dplyr::select(c(ceni_site_vote_ID.x,latitude, longitude)) %>%
  dplyr::filter(!is.na(latitude)) %>%
  dplyr::mutate(source = "SIGE")

matching_filtered_3 <- matching_binded_3 %>% dplyr::filter(is.na(latitude)) 
matching_filtered_wo_dup_3 <- matching_filtered_3 %>% dplyr::filter(!str_detect(match_var, "ACADEMIE")) %>% distinct(ceni_site_vote_ID, circonscription, latitude, .keep_all=TRUE)

x_3 <- nrow(georeference_villes_3)
y_3 <- nrow(matching_binded_3)
z_3 <- nrow(matching_filtered_3) - nrow(matching_filtered_wo_dup_3)

matching_performance_3 <- x_3/(y_3-z_3)*100
matching_performance_3

# matching_binded_4 <- left_join(matching_binded, matching_binded_3, by="match_var") %>% dplyr::mutate(latitude.x = ifelse(is.na(latitude.x), latitude.y, latitude.x)) %>% dplyr::mutate(longitude.x = ifelse(is.na(longitude.x), longitude.y, longitude.x))
#   
# matching_filtered_4 <- left_join(matching_binded, matching_binded_3, by="match_var") %>% dplyr::mutate(latitude.x = ifelse(is.na(latitude.x), latitude.y, latitude.x)) %>% dplyr::mutate(longitude.x = ifelse(is.na(longitude.x), longitude.y, longitude.x)) %>% dplyr::filter(is.na(latitude.x)) 
# 
# matching_filtered_wo_dup_4 <- matching_filtered_4 %>% dplyr::filter(!str_detect(match_var, "ACADEMIE")) %>% distinct(ceni_site_vote_ID.x, circonscription.x, latitude.x, .keep_all=TRUE)

`%notin%` <- Negate(`%in%`)
matching_filtered_1 <- dplyr::filter(matching_filtered, ceni_site_vote_ID %notin% matching_filtered_2$ceni_site_vote_ID )
matching_filtered_1 <- filter(matching_filtered_1, ceni_site_vote_ID %notin% matching_filtered_3$ceni_site_vote_ID )
matching_filtered_wo_dup_1 <- matching_filtered_1 %>% dplyr::filter(!str_detect(match_var, "ACADEMIE")) %>% distinct(ceni_site_vote_ID, circonscription, latitude, .keep_all=TRUE)


z_1 <- nrow(matching_filtered_1) - nrow(matching_filtered_wo_dup_1)

matching_performance_final <- (x+x_2+x_3)/(y-z_1)*100
matching_performance_final

```

